<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainActivity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">xyz.steidle.cellnetinfo</a> &gt; <span class="el_source">MainActivity.java</span></div><h1>MainActivity.java</h1><pre class="source lang-java linenums">package xyz.steidle.cellnetinfo;

import android.Manifest;
import android.app.ActivityManager;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.content.SharedPreferences;
import android.content.pm.PackageManager;
import android.location.LocationListener;
import android.location.LocationManager;
import android.os.Build;
import android.os.Bundle;
import android.telephony.CellInfo;
import android.util.Log;
import android.view.View;
import android.widget.ListView;
import android.widget.TextView;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;
import androidx.preference.PreferenceManager;

import java.util.Arrays;
import java.util.List;

import xyz.steidle.cellnetinfo.utils.CellInfoHandler;
import xyz.steidle.cellnetinfo.utils.DataHolder;
import xyz.steidle.cellnetinfo.utils.DatabaseHandler;
import xyz.steidle.cellnetinfo.utils.Reload;
import xyz.steidle.cellnetinfo.view.CellInfoAdapter;

<span class="nc" id="L36">public class MainActivity extends AppCompatActivity {</span>
  private ListView cellInfoListView;
  private TextView noCellsTextView;
  private TextView statusTextView;
  private BroadcastReceiver receiver;
  private CellInfoHandler cellInfoHandler;
  private DatabaseHandler databaseHandler;

<span class="nc" id="L44">  private int locationRefreshTime = 15000; // 15 seconds to update</span>
<span class="nc" id="L45">  private int locationRefreshDistance = 500; // 500 meters to update</span>

<span class="nc" id="L47">  private final LocationListener mLocationListener = location -&gt; DataHolder.getInstance().setLocation(location);</span>

  @Override
  protected void onCreate(Bundle savedInstanceState) {
<span class="nc" id="L51">    super.onCreate(savedInstanceState);</span>
<span class="nc" id="L52">    setContentView(R.layout.activity_main);</span>

<span class="nc" id="L54">    cellInfoHandler = new CellInfoHandler(this);</span>
<span class="nc" id="L55">    databaseHandler = new DatabaseHandler(this);</span>

<span class="nc" id="L57">    cellInfoListView = findViewById(R.id.listScrollView);</span>
<span class="nc" id="L58">    noCellsTextView = findViewById(R.id.noCellsWarning);</span>
<span class="nc" id="L59">    statusTextView = findViewById(R.id.statusTextView);</span>

    // change activity based on button press
<span class="nc" id="L62">    findViewById(R.id.buttonHelp).setOnClickListener(view -&gt; openNewActivity(HelpActivity.class));</span>
<span class="nc" id="L63">    findViewById(R.id.buttonHistory).setOnClickListener(view -&gt; openNewActivity(HistoryActivity.class));</span>
<span class="nc" id="L64">    findViewById(R.id.buttonSettings).setOnClickListener(view -&gt; openNewActivity(SettingsActivity.class));</span>

<span class="nc" id="L66">    initializeApplicationLogic();</span>
<span class="nc" id="L67">  }</span>

  /** function to initialize all logics.
   * calls location and preferences function and creates the foreground service
   */
  private void initializeApplicationLogic() {
<span class="nc" id="L73">    handleLocationManager();</span>
<span class="nc" id="L74">    handlePreferences();</span>
<span class="nc" id="L75">    createBackgroundReload();</span>

<span class="nc bnc" id="L77" title="All 4 branches missed.">    if (!foregroundServiceRunning() &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {</span>
<span class="nc" id="L78">      Intent reloadServiceIntent = new Intent(this, Reload.class);</span>
<span class="nc" id="L79">      startForegroundService(reloadServiceIntent);</span>
    }
<span class="nc" id="L81">  }</span>

  /** checks if foreground service Reload.java is running */
  public boolean foregroundServiceRunning() {
<span class="nc" id="L85">    ActivityManager activityManager = (ActivityManager) getSystemService(Context.ACTIVITY_SERVICE);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">    for (ActivityManager.RunningServiceInfo service : activityManager.getRunningServices(Integer.MAX_VALUE)) {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">      if (Reload.class.getName().equals(service.service.getClassName())) {</span>
<span class="nc" id="L88">        return true;</span>
      }
<span class="nc" id="L90">    }</span>
<span class="nc" id="L91">    return false;</span>
  }

  /** Creates new location manager and requests location updates based on settings */
  private void handleLocationManager() {
<span class="nc" id="L96">    LocationManager mLocationManager = (LocationManager) getSystemService(LOCATION_SERVICE);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">    if (ContextCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc" id="L98">      ActivityCompat.requestPermissions(this, new String[]{Manifest.permission.ACCESS_FINE_LOCATION}, 12);</span>
<span class="nc" id="L99">      return;</span>
    }
<span class="nc" id="L101">    mLocationManager.requestLocationUpdates(LocationManager.GPS_PROVIDER, locationRefreshTime, locationRefreshDistance, mLocationListener);</span>
<span class="nc" id="L102">  }</span>

  /** Gets preference values and registers new preference change listener */
  private void handlePreferences() {
<span class="nc" id="L106">    SharedPreferences sharedPreferences = PreferenceManager.getDefaultSharedPreferences(this /* Activity context */);</span>
<span class="nc" id="L107">    Log.d(&quot;Prefs&quot;, String.valueOf(sharedPreferences.getAll()));</span>
<span class="nc" id="L108">    locationRefreshTime = Integer.parseInt(sharedPreferences.getString(&quot;min_update_time&quot;, String.valueOf(locationRefreshTime)));</span>
<span class="nc" id="L109">    locationRefreshDistance = Integer.parseInt(sharedPreferences.getString(&quot;min_update_loc&quot;, String.valueOf(locationRefreshDistance)));</span>

<span class="nc" id="L111">    sharedPreferences.registerOnSharedPreferenceChangeListener((sharedPreferences1, s) -&gt; {</span>
<span class="nc" id="L112">      locationRefreshTime = Integer.parseInt(sharedPreferences1.getString(&quot;min_update_time&quot;, String.valueOf(locationRefreshTime)));</span>
<span class="nc" id="L113">      locationRefreshDistance = Integer.parseInt(sharedPreferences1.getString(&quot;min_update_loc&quot;, String.valueOf(locationRefreshDistance)));</span>
<span class="nc" id="L114">      Log.d(&quot;Preferences:UpdateString&quot;, s);</span>
<span class="nc" id="L115">      Log.d(&quot;Preferences:Update&quot;, String.valueOf(locationRefreshTime));</span>
<span class="nc" id="L116">      Log.d(&quot;Preferences:Update&quot;, String.valueOf(locationRefreshDistance));</span>
<span class="nc" id="L117">    });</span>
<span class="nc" id="L118">  }</span>

  /** Handles creation of background task to reload cells */
  private void createBackgroundReload() {
<span class="nc" id="L122">    IntentFilter intentFilter = new IntentFilter();</span>
<span class="nc" id="L123">    intentFilter.addAction(&quot;android.intent.action.TIME_TICK&quot;);</span>
<span class="nc" id="L124">    receiver = new BroadcastReceiver() {</span>
      @Override
      public void onReceive(Context context, Intent intent) {
<span class="nc" id="L127">        reloadCells();</span>
<span class="nc" id="L128">      }</span>
    };
<span class="nc" id="L130">    registerReceiver(receiver, intentFilter);</span>

<span class="nc" id="L132">    reloadCells();</span>
<span class="nc" id="L133">  }</span>

  /** Restart cell scan and displays all cells in list. */
  protected void reloadCells() {
<span class="nc" id="L137">    setStatus(R.string.status_searching);</span>

<span class="nc" id="L139">    List&lt;CellInfo&gt; cellInfoList = cellInfoHandler.getCells();</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">    for (CellInfo cellInfo : cellInfoList)</span>
<span class="nc" id="L142">      databaseHandler.addCell(cellInfo);</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">    if (!cellInfoList.isEmpty()) {</span>
<span class="nc" id="L145">      noCellsTextView.setVisibility(View.INVISIBLE);</span>
<span class="nc" id="L146">      cellInfoListView.setAdapter(new CellInfoAdapter(this, cellInfoList));</span>
<span class="nc" id="L147">      resetStatus();</span>
    } else {
<span class="nc" id="L149">      noCellsTextView.setVisibility(View.VISIBLE);</span>
<span class="nc" id="L150">      setStatus(R.string.status_wrong);</span>
    }
<span class="nc" id="L152">  }</span>

  /** Sets status in status bar from given resource id.
   * @param strId Status String ID
   */
  private void setStatus(int strId) {
<span class="nc" id="L158">    Log.d(&quot;MainActivity&quot;, getResources().getString(strId));</span>
<span class="nc" id="L159">    statusTextView.setText(getResources().getString(strId));</span>
<span class="nc" id="L160">  }</span>

  /** Sets status text to empty */
  private void resetStatus() {
<span class="nc" id="L164">    statusTextView.setText(&quot;&quot;);</span>
<span class="nc" id="L165">  }</span>

  /** starts new activity based on given class parameter
   * @param cls class of the activity to open
   */
  private void openNewActivity(Class&lt;?&gt; cls)  {
<span class="nc" id="L171">    Intent intent = new Intent(this, cls);</span>
<span class="nc" id="L172">    startActivity(intent);</span>
<span class="nc" id="L173">  }</span>

  @Override
  protected void onDestroy() {
<span class="nc" id="L177">    super.onDestroy();</span>
<span class="nc" id="L178">    unregisterReceiver(receiver);</span>

<span class="nc" id="L180">    Intent intent = new Intent(this, Reload.class);</span>
<span class="nc" id="L181">    stopService(intent);</span>
<span class="nc" id="L182">  }</span>

  /**
   * @deprecated
   */
  @Deprecated
  @Override
  public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
<span class="nc" id="L190">    super.onRequestPermissionsResult(requestCode, permissions, grantResults);</span>

<span class="nc" id="L192">    int indexLocationPermission = Arrays.binarySearch(permissions, Manifest.permission.ACCESS_FINE_LOCATION);</span>

<span class="nc bnc" id="L194" title="All 4 branches missed.">    if (requestCode == 12 &amp;&amp; grantResults[indexLocationPermission] == 0) {</span>
<span class="nc" id="L195">      initializeApplicationLogic();</span>
    }
<span class="nc" id="L197">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>